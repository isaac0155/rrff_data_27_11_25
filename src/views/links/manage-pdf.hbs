<style>
    #pdfCanvas {
        border: 2px solid black;
        margin-top: 10px;
        width: 100%;
        max-width: 660px;
        height: 900px;
    }

    .editing-row {
        background-color: #ffeb99 !important;
        /* Color amarillo para resaltar edici√≥n */
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

<div class="container py-4">
    <h1 class="text-center">Editor de PDF</h1>

    <!-- Tabla de PDFs -->
    <div class="row mt-3">
        <table class="table table-striped table-bordered table-sm">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Estado</th>
                    <th>Nombre</th>
                    <th>Resumen</th>
                    <th>Opciones</th>
                </tr>
            </thead>
            <tbody id="pdfTableBody">
                {{#each pdf}}
                <tr id="row_{{id}}">
                    <td>{{id}}</td>
                    <td>{{#if status}}‚úÖ Activo{{else}}‚ùå Inactivo{{/if}}</td>
                    <td>
                        <input type="text" id="name_{{id}}" value="{{name}}" class="form-control form-control-sm"
                            disabled>
                    </td>
                    <td>
                        <input type="text" id="name_show_{{id}}" value="{{name_show}}"
                            class="form-control form-control-sm" disabled>
                    </td>
                    <td>
                        <button class="btn btn-info btn-sm m-0" onclick="loadPdfContent({{id}})">‚úè Editar</button>
                        <button class="btn btn-success btn-sm m-0" onclick="downloadPdf_id({{id}}, '{{name_show}}')">‚¨á
                            Descargar</button>
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>

    <!-- Botones -->
    <div class="row mt-3">
        <div class="col-md-12 d-flex gap-2 justify-content-center">
            <button class="btn btn-primary btn-sm" id="createPdfBtn" onclick="createNewPdf()">‚ûï Crear PDF</button>
            <button class="btn btn-warning btn-sm" id="savePdfBtn" onclick="savePdf()" style="display: none;">üíæ Guardar
                PDF</button>
            <button class="btn btn-info btn-sm" id="saveEditBtn" onclick="saveEditPdf()" style="display: none;">üíæ
                Guardar Cambios</button>
        </div>
    </div>

    <hr>

    <!-- Opciones de edici√≥n -->
    <div class="row">
        <div class="col-md-12 d-flex gap-2 justify-content-center">
            <button class="btn btn-primary btn-sm" onclick="addText()">üìù A√±adir Texto</button>
            <select id="fontFamily" class="form-select form-control-sm w-auto" onchange="changeFontFamily()">
                <option value="Arial">Arial</option>
                <option value="Times New Roman">Times New Roman</option>
                <option value="Courier New">Courier New</option>
                <option value="Verdana">Verdana</option>
            </select>
            <input type="number" id="fontSize" class="form-control form-control-sm w-auto" min="10" max="100" value="20"
                onchange="changeFontSize()">
            <button class="btn btn-secondary btn-sm" onclick="toggleBold()">B</button>
            <button class="btn btn-secondary btn-sm" onclick="toggleItalic()">I</button>
            <button class="btn btn-secondary btn-sm" onclick="toggleUnderline()">U</button>
            <input type="color" id="colorPicker" class="form-control form-control-color" onchange="changeColor()">
        </div>
    </div>

    <!-- Cargar im√°genes -->
    <div class="row mt-3">
        <div class="col-md-12 d-flex flex-wrap gap-2 justify-content-center">
            <input type="file" id="imageInput" accept="image/*" class="form-control w-auto">
        </div>
    </div>

    <!-- Canvas -->
    <div class="d-flex justify-content-center">
        <canvas id="pdfCanvas" width="660" height="900"></canvas>
    </div>
</div>

<script>
    const canvas = new fabric.Canvas('pdfCanvas');
    let editPdfId = null;

    function addText() {
        const text = new fabric.Textbox('Texto aqu√≠', { left: 50, top: 50, fontSize: 20, fill: 'black', fontFamily: 'Arial' });
        canvas.add(text);
    }

    function changeColor() {
        const color = document.getElementById('colorPicker').value;
        const activeObject = canvas.getActiveObject();
        if (activeObject && activeObject.type === 'textbox') {
            activeObject.set('fill', color);
            canvas.renderAll();
        }
    }

    function changeFontFamily() {
        const fontFamily = document.getElementById('fontFamily').value;
        const activeObject = canvas.getActiveObject();
        if (activeObject && activeObject.type === 'textbox') {
            activeObject.set('fontFamily', fontFamily);
            canvas.renderAll();
        }
    }

    function changeFontSize() {
        const fontSize = document.getElementById('fontSize').value;
        const activeObject = canvas.getActiveObject();
        if (activeObject && activeObject.type === 'textbox') {
            activeObject.set('fontSize', parseInt(fontSize));
            canvas.renderAll();
        }
    }

    function toggleBold() {
        const activeObject = canvas.getActiveObject();
        if (activeObject && activeObject.type === 'textbox') {
            activeObject.set('fontWeight', activeObject.fontWeight === 'bold' ? 'normal' : 'bold');
            canvas.renderAll();
        }
    }

    function toggleItalic() {
        const activeObject = canvas.getActiveObject();
        if (activeObject && activeObject.type === 'textbox') {
            activeObject.set('fontStyle', activeObject.fontStyle === 'italic' ? 'normal' : 'italic');
            canvas.renderAll();
        }
    }

    function toggleUnderline() {
        const activeObject = canvas.getActiveObject();
        if (activeObject && activeObject.type === 'textbox') {
            activeObject.set('underline', !activeObject.underline);
            canvas.renderAll();
        }
    }

    async function loadPdfContent(documentId) {
        try {
            const response = await fetch(`/links/generate-pdf/${documentId}`);
            if (!response.ok) throw new Error('No se pudo recuperar el contenido');

            const data = await response.json();
            canvas.loadFromJSON(data.content, () => canvas.renderAll());

            editPdfId = documentId;

            document.getElementById(`row_${documentId}`).classList.add('editing-row');
            document.getElementById(`row_${documentId}`).classList.add('table-warning');
            document.getElementById(`name_${documentId}`).disabled = false;
            document.getElementById(`name_show_${documentId}`).disabled = false;

            document.getElementById('saveEditBtn').style.display = 'block';
        } catch (error) {
            console.error("Error al cargar el contenido:", error);
        }
    }

    async function savePdf() {
        const json = JSON.stringify(canvas.toJSON());
        await fetch('/links/save-pdf', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: json })
        });
        alert('PDF guardado');
    }

    async function saveEditPdf() {
        const json = JSON.stringify(canvas.toJSON());
        await fetch(`/links/save-edit-pdf/${editPdfId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: json })
        });
        alert('Cambios guardados');
    }

    function createNewPdf() {
        document.getElementById('savePdfBtn').style.display = 'block';
    }
</script>